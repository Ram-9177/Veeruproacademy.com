'use client'

import { useState, useEffect, useRef } from 'react'
import { Play, Save, Share, Download, RefreshCw, Maximize2, Minimize2 } from 'lucide-react'

interface RealtimeSandboxProps {
  initialHtml?: string
  initialCss?: string
  initialJs?: string
  onSave?: (_code: { html: string; css: string; js: string }) => void
  className?: string
}

export function RealtimeSandbox({
  initialHtml = '',
  initialCss = '',
  initialJs = '',
  onSave,
  className = ''
}: RealtimeSandboxProps) {
  const [html, setHtml] = useState(initialHtml)
  const [css, setCss] = useState(initialCss)
  const [js, setJs] = useState(initialJs)
  const [activeTab, setActiveTab] = useState<'html' | 'css' | 'js'>('html')
  const [isFullscreen, setIsFullscreen] = useState(false)
  const [isRunning, setIsRunning] = useState(false)
  const iframeRef = useRef<HTMLIFrameElement>(null)
  const debounceRef = useRef<NodeJS.Timeout>()

  // Auto-run code with debounce
  useEffect(() => {
    if (debounceRef.current) {
      clearTimeout(debounceRef.current)
    }
    
    debounceRef.current = setTimeout(() => {
      if (!iframeRef.current) return
      
      setIsRunning(true)
      
      const code = `
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Sandbox Preview</title>
          <style>
            body {
              margin: 0;
              padding: 20px;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #ffffff;
              color: #333333;
            }
            * {
              box-sizing: border-box;
            }
            ${css}
          </style>
        </head>
        <body>
          ${html}
          <script>
            try {
              ${js}
            } catch (error) {
              console.error('JavaScript Error:', error);
              document.body.innerHTML += '<div style="background: #fee; border: 1px solid #fcc; padding: 10px; margin: 10px 0; border-radius: 4px; color: #c33;"><strong>JavaScript Error:</strong> ' + error.message + '</div>';
            }
          </script>
        </body>
        </html>
      `
      
      const blob = new Blob([code], { type: 'text/html' })
      const url = URL.createObjectURL(blob)
      
      iframeRef.current.src = url
      
      // Clean up the blob URL after a short delay
      setTimeout(() => {
        URL.revokeObjectURL(url)
        setIsRunning(false)
      }, 100)
    }, 500)

    return () => {
      if (debounceRef.current) {
        clearTimeout(debounceRef.current)
      }
    }
  }, [html, css, js])

  const runCodeManually = () => {
    if (!iframeRef.current) return
    
    setIsRunning(true)
    
    const code = `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sandbox Preview</title>
        <style>
          body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333333;
          }
          * {
            box-sizing: border-box;
          }
          ${css}
        </style>
      </head>
      <body>
        ${html}
        <script>
          try {
            ${js}
          } catch (error) {
            console.error('JavaScript Error:', error);
            document.body.innerHTML += '<div style="background: #fee; border: 1px solid #fcc; padding: 10px; margin: 10px 0; border-radius: 4px; color: #c33;"><strong>JavaScript Error:</strong> ' + error.message + '</div>';
          }
        </script>
      </body>
      </html>
    `
    
    const blob = new Blob([code], { type: 'text/html' })
    const url = URL.createObjectURL(blob)
    
    iframeRef.current.src = url
    
    // Clean up the blob URL after a short delay
    setTimeout(() => {
      URL.revokeObjectURL(url)
      setIsRunning(false)
    }, 100)
  }

  const handleSave = () => {
    if (onSave) {
      onSave({ html, css, js })
    }
  }

  const handleShare = async () => {
    const code = { html, css, js }
    try {
      await navigator.clipboard.writeText(JSON.stringify(code, null, 2))
      // You could show a toast here
    } catch (err) {
      console.error('Failed to copy to clipboard:', err)
    }
  }

  const handleDownload = () => {
    const code = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sandbox Export</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    ${css}
  </style>
</head>
<body>
  ${html}
  <script>
    ${js}
  </script>
</body>
</html>
    `
    
    const blob = new Blob([code], { type: 'text/html' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = 'sandbox-export.html'
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }

  const tabs = [
    { id: 'html' as const, label: 'HTML', color: 'text-orange-400' },
    { id: 'css' as const, label: 'CSS', color: 'text-blue-400' },
    { id: 'js' as const, label: 'JavaScript', color: 'text-yellow-400' }
  ]

  return (
    <div className={`flex flex-col h-full bg-gray-900 rounded-lg overflow-hidden ${className}`}>
      {/* Header */}
      <div className="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700">
        <div className="flex items-center gap-4">
          <h3 className="text-white font-semibold">Live Sandbox</h3>
          {isRunning && (
            <div className="flex items-center gap-2 text-green-400">
              <RefreshCw className="w-4 h-4 animate-spin" />
              <span className="text-sm">Running...</span>
            </div>
          )}
        </div>
        
        <div className="flex items-center gap-2">
          <button
            onClick={runCodeManually}
            className="flex items-center gap-2 px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors"
          >
            <Play className="w-4 h-4" />
            Run
          </button>
          <button
            onClick={handleSave}
            className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
          >
            <Save className="w-4 h-4" />
            Save
          </button>
          <button
            onClick={handleShare}
            className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors"
          >
            <Share className="w-4 h-4" />
            Share
          </button>
          <button
            onClick={handleDownload}
            className="flex items-center gap-2 px-3 py-1.5 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors"
          >
            <Download className="w-4 h-4" />
            Export
          </button>
          <button
            onClick={() => setIsFullscreen(!isFullscreen)}
            className="flex items-center gap-2 px-3 py-1.5 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors"
          >
            {isFullscreen ? <Minimize2 className="w-4 h-4" /> : <Maximize2 className="w-4 h-4" />}
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex flex-1 overflow-hidden">
        {/* Code Editor */}
        <div className="flex flex-col w-1/2 border-r border-gray-700">
          {/* Tabs */}
          <div className="flex bg-gray-800 border-b border-gray-700">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`px-4 py-2 text-sm font-medium transition-colors ${
                  activeTab === tab.id
                    ? `${tab.color} bg-gray-700`
                    : 'text-gray-400 hover:text-white hover:bg-gray-700/50'
                }`}
              >
                {tab.label}
              </button>
            ))}
          </div>

          {/* Code Input */}
          <div className="flex-1">
            {activeTab === 'html' && (
              <textarea
                value={html}
                onChange={(e) => setHtml(e.target.value)}
                className="w-full h-full p-4 bg-gray-900 text-white font-mono text-sm resize-none border-none outline-none"
                placeholder="Enter your HTML here..."
                spellCheck={false}
              />
            )}
            {activeTab === 'css' && (
              <textarea
                value={css}
                onChange={(e) => setCss(e.target.value)}
                className="w-full h-full p-4 bg-gray-900 text-white font-mono text-sm resize-none border-none outline-none"
                placeholder="Enter your CSS here..."
                spellCheck={false}
              />
            )}
            {activeTab === 'js' && (
              <textarea
                value={js}
                onChange={(e) => setJs(e.target.value)}
                className="w-full h-full p-4 bg-gray-900 text-white font-mono text-sm resize-none border-none outline-none"
                placeholder="Enter your JavaScript here..."
                spellCheck={false}
              />
            )}
          </div>
        </div>

        {/* Preview */}
        <div className="flex flex-col w-1/2">
          <div className="flex items-center justify-between p-3 bg-gray-800 border-b border-gray-700">
            <h4 className="text-white font-medium">Preview</h4>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 bg-red-500 rounded-full"></div>
              <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
              <div className="w-3 h-3 bg-green-500 rounded-full"></div>
            </div>
          </div>
          <iframe
            ref={iframeRef}
            className="flex-1 w-full bg-white"
            title="Sandbox Preview"
            sandbox="allow-scripts allow-same-origin"
          />
        </div>
      </div>
    </div>
  )
}          />
        </div>
      </div>
    </div>
  )
}
